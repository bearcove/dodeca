# Nextest configuration for dodeca
# See: https://nexte.st/docs/configuration/

experimental = ["wrapper-scripts", "setup-scripts"]

# Setup script to build cells before running tests
[scripts.setup.build-cells]
command = 'cargo build --workspace --exclude dodeca-devtools'

# Default profile - excludes integration tests (use `cargo xtask integration` instead)
[profile.default]
# Limit parallelism globally
test-threads = 4
# Exclude integration tests - they are run via `cargo xtask integration`
default-filter = 'not test(serve::)'

[[profile.default.scripts]]
platform = 'cfg(target_os = "linux")'
filter = 'not test(serve::)'
setup = 'build-cells'

[scripts.wrapper.heaptrack]
# Run tests under heaptrack for memory profiling
command = 'heaptrack'

# Heaptrack profile - runs tests under heaptrack
[profile.heaptrack]

[[profile.heaptrack.scripts]]
# Apply heaptrack wrapper to all tests on Linux
platform = 'cfg(target_os = "linux")'
filter = 'all()'
run-wrapper = 'heaptrack'

[scripts.wrapper.strace]
# Run tests under strace for syscall tracing
command = '/home/amos/bearcove/dodeca/.config/strace-wrapper.sh'

# Strace profile - runs tests under strace
[profile.strace]

[[profile.strace.scripts]]
# Apply strace wrapper to all tests on Linux
platform = 'cfg(target_os = "linux")'
filter = 'all()'
run-wrapper = 'strace'

[scripts.wrapper.perf]
# Run tests under perf for memory profiling
command = '/home/amos/bearcove/dodeca/.config/perf-wrapper.sh'

# Perf profile - runs tests under perf
[profile.perf]

[[profile.perf.scripts]]
# Apply perf wrapper to all tests on Linux
platform = 'cfg(target_os = "linux")'
filter = 'all()'
run-wrapper = 'perf'

[scripts.wrapper.systemd-run]
# Run tests under systemd-run with memory limit to prevent OOM
command = '/home/amos/bearcove/dodeca/.config/systemd-run-wrapper.sh'

# Systemd-run profile - runs tests under systemd-run with 4GB memory limit
[profile.systemd-run]

[[profile.systemd-run.scripts]]
# Apply systemd-run wrapper to all tests on Linux
platform = 'cfg(target_os = "linux")'
filter = 'all()'
run-wrapper = 'systemd-run'
