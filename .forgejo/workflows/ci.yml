# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: CI
"on": 
  push: 
    tags: 
      - v*

    branches: 
      - main

  pull_request: 
    branches: 
      - main

  workflow_dispatch: 
permissions: 
  contents: read

env: 
  CARGO_TERM_COLOR: always

jobs: 
  clippy: 
    name: Clippy
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    continue-on-error: true
    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/home/amos/.cache/dodeca-ci/clippy\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/home/amos/.cache/dodeca-ci/clippy\" target && echo \"Cache restored via ctree from /home/amos/.cache/dodeca-ci/clippy\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /home/amos/.cache/dodeca-ci/clippy\"\nfi"
      - 
        name: Clippy
        run: cargo +nightly-2025-12-19 -Z checksum-freshness clippy --all-features --all-targets -- -D warnings
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/home/amos/.cache/dodeca-ci/clippy\")\"\nrm -rf \"/home/amos/.cache/dodeca-ci/clippy\" 2>/dev/null || true\nctree target \"/home/amos/.cache/dodeca-ci/clippy\" && echo \"Cache saved via ctree to /home/amos/.cache/dodeca-ci/clippy\" || echo \"ctree save failed (non-fatal)\""

  build-wasm: 
    name: Build WASM
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19
          targets: wasm32-unknown-unknown

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/home/amos/.cache/dodeca-ci/wasm\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/home/amos/.cache/dodeca-ci/wasm\" target && echo \"Cache restored via ctree from /home/amos/.cache/dodeca-ci/wasm\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /home/amos/.cache/dodeca-ci/wasm\"\nfi"
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Upload WASM to S3
        run: "tar -czf /tmp/wasm.tar.gz -C crates/dodeca-devtools pkg\n./scripts/cas-upload.ts /tmp/wasm.tar.gz \"ci/${{ github.run_id }}/wasm.tar.gz\""
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/home/amos/.cache/dodeca-ci/wasm\")\"\nrm -rf \"/home/amos/.cache/dodeca-ci/wasm\" 2>/dev/null || true\nctree target \"/home/amos/.cache/dodeca-ci/wasm\" && echo \"Cache saved via ctree to /home/amos/.cache/dodeca-ci/wasm\" || echo \"ctree save failed (non-fatal)\""

  build-ddc-linux-x64: 
    name: Build ddc (linux-x64)
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/home/amos/.cache/dodeca-ci/ddc-linux-x64\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/home/amos/.cache/dodeca-ci/ddc-linux-x64\" target && echo \"Cache restored via ctree from /home/amos/.cache/dodeca-ci/ddc-linux-x64\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /home/amos/.cache/dodeca-ci/ddc-linux-x64\"\nfi"
      - 
        name: Build ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness build --release -p dodeca
      - 
        name: Test ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness test --release -p dodeca --bins
      - 
        name: Upload ddc to S3
        run: "./scripts/cas-upload.ts target/release/ddc \"ci/${{ github.run_id }}/ddc-linux-x64\""
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/home/amos/.cache/dodeca-ci/ddc-linux-x64\")\"\nrm -rf \"/home/amos/.cache/dodeca-ci/ddc-linux-x64\" 2>/dev/null || true\nctree target \"/home/amos/.cache/dodeca-ci/ddc-linux-x64\" && echo \"Cache saved via ctree to /home/amos/.cache/dodeca-ci/ddc-linux-x64\" || echo \"ctree save failed (non-fatal)\""

  build-cells-linux-x64-1: 
    name: Build cells (linux-x64) [cell-arborium, cell-code-execution, cell-css, cell-fonts, cell-html, cell-html-diff, cell-http, cell-image, cell-js]
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/home/amos/.cache/dodeca-ci/cells-linux-x64-1\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/home/amos/.cache/dodeca-ci/cells-linux-x64-1\" target && echo \"Cache restored via ctree from /home/amos/.cache/dodeca-ci/cells-linux-x64-1\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /home/amos/.cache/dodeca-ci/cells-linux-x64-1\"\nfi"
      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness build --release -p cell-arborium --bin ddc-cell-arborium -p cell-code-execution --bin ddc-cell-code-execution -p cell-css --bin ddc-cell-css -p cell-fonts --bin ddc-cell-fonts -p cell-html --bin ddc-cell-html -p cell-html-diff --bin ddc-cell-html-diff -p cell-http --bin ddc-cell-http -p cell-image --bin ddc-cell-image -p cell-js --bin ddc-cell-js
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness test --release -p cell-arborium -p cell-code-execution -p cell-css -p cell-fonts -p cell-html -p cell-html-diff -p cell-http -p cell-image -p cell-js
      - 
        name: Upload cells to S3
        run: "./scripts/cas-upload-batch.sh \"ci/${{ github.run_id }}/cells-linux-x64\" target/release/ddc-cell-arborium target/release/ddc-cell-code-execution target/release/ddc-cell-css target/release/ddc-cell-fonts target/release/ddc-cell-html target/release/ddc-cell-html-diff target/release/ddc-cell-http target/release/ddc-cell-image target/release/ddc-cell-js"
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/home/amos/.cache/dodeca-ci/cells-linux-x64-1\")\"\nrm -rf \"/home/amos/.cache/dodeca-ci/cells-linux-x64-1\" 2>/dev/null || true\nctree target \"/home/amos/.cache/dodeca-ci/cells-linux-x64-1\" && echo \"Cache saved via ctree to /home/amos/.cache/dodeca-ci/cells-linux-x64-1\" || echo \"ctree save failed (non-fatal)\""

  build-cells-linux-x64-2: 
    name: Build cells (linux-x64) [cell-jxl, cell-linkcheck, cell-markdown, cell-minify, cell-pagefind, cell-sass, cell-svgo, cell-tui, cell-webp]
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/home/amos/.cache/dodeca-ci/cells-linux-x64-2\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/home/amos/.cache/dodeca-ci/cells-linux-x64-2\" target && echo \"Cache restored via ctree from /home/amos/.cache/dodeca-ci/cells-linux-x64-2\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /home/amos/.cache/dodeca-ci/cells-linux-x64-2\"\nfi"
      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness build --release -p cell-jxl --bin ddc-cell-jxl -p cell-linkcheck --bin ddc-cell-linkcheck -p cell-markdown --bin ddc-cell-markdown -p cell-minify --bin ddc-cell-minify -p cell-pagefind --bin ddc-cell-pagefind -p cell-sass --bin ddc-cell-sass -p cell-svgo --bin ddc-cell-svgo -p cell-tui --bin ddc-cell-tui -p cell-webp --bin ddc-cell-webp
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness test --release -p cell-jxl -p cell-linkcheck -p cell-markdown -p cell-minify -p cell-pagefind -p cell-sass -p cell-svgo -p cell-tui -p cell-webp
      - 
        name: Upload cells to S3
        run: "./scripts/cas-upload-batch.sh \"ci/${{ github.run_id }}/cells-linux-x64\" target/release/ddc-cell-jxl target/release/ddc-cell-linkcheck target/release/ddc-cell-markdown target/release/ddc-cell-minify target/release/ddc-cell-pagefind target/release/ddc-cell-sass target/release/ddc-cell-svgo target/release/ddc-cell-tui target/release/ddc-cell-webp"
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/home/amos/.cache/dodeca-ci/cells-linux-x64-2\")\"\nrm -rf \"/home/amos/.cache/dodeca-ci/cells-linux-x64-2\" 2>/dev/null || true\nctree target \"/home/amos/.cache/dodeca-ci/cells-linux-x64-2\" && echo \"Cache saved via ctree to /home/amos/.cache/dodeca-ci/cells-linux-x64-2\" || echo \"ctree save failed (non-fatal)\""

  integration-linux-x64: 
    name: Integration (linux-x64)
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    needs: 
      - build-ddc-linux-x64
      - build-cells-linux-x64-1
      - build-cells-linux-x64-2

    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/home/amos/.cache/dodeca-ci/integration-linux-x64\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/home/amos/.cache/dodeca-ci/integration-linux-x64\" target && echo \"Cache restored via ctree from /home/amos/.cache/dodeca-ci/integration-linux-x64\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /home/amos/.cache/dodeca-ci/integration-linux-x64\"\nfi"
      - 
        name: Download ddc from S3
        run: "./scripts/cas-download.ts \"ci/${{ github.run_id }}/ddc-linux-x64\" dist/ddc"
      - 
        name: Download cells from S3
        run: "./scripts/cas-download-batch.sh \"ci/${{ github.run_id }}/cells-linux-x64\" dist/"
      - 
        name: List binaries
        run: ls -la dist/
      - 
        name: Verify artifacts
        run: "#!/bin/bash\nset -euo pipefail\n\necho 'Verifying all required binaries exist in dist/'\nmissing=0\n\nif [[ ! -x dist/ddc ]]; then\n  echo '❌ MISSING: ddc'\n  missing=1\nelse\n  echo '✓ ddc'\nfi\n\nif [[ ! -x dist/ddc-cell-arborium ]]; then\n  echo '❌ MISSING: ddc-cell-arborium'\n  missing=1\nelse\n  echo '✓ ddc-cell-arborium'\nfi\n\nif [[ ! -x dist/ddc-cell-code-execution ]]; then\n  echo '❌ MISSING: ddc-cell-code-execution'\n  missing=1\nelse\n  echo '✓ ddc-cell-code-execution'\nfi\n\nif [[ ! -x dist/ddc-cell-css ]]; then\n  echo '❌ MISSING: ddc-cell-css'\n  missing=1\nelse\n  echo '✓ ddc-cell-css'\nfi\n\nif [[ ! -x dist/ddc-cell-fonts ]]; then\n  echo '❌ MISSING: ddc-cell-fonts'\n  missing=1\nelse\n  echo '✓ ddc-cell-fonts'\nfi\n\nif [[ ! -x dist/ddc-cell-html ]]; then\n  echo '❌ MISSING: ddc-cell-html'\n  missing=1\nelse\n  echo '✓ ddc-cell-html'\nfi\n\nif [[ ! -x dist/ddc-cell-html-diff ]]; then\n  echo '❌ MISSING: ddc-cell-html-diff'\n  missing=1\nelse\n  echo '✓ ddc-cell-html-diff'\nfi\n\nif [[ ! -x dist/ddc-cell-http ]]; then\n  echo '❌ MISSING: ddc-cell-http'\n  missing=1\nelse\n  echo '✓ ddc-cell-http'\nfi\n\nif [[ ! -x dist/ddc-cell-image ]]; then\n  echo '❌ MISSING: ddc-cell-image'\n  missing=1\nelse\n  echo '✓ ddc-cell-image'\nfi\n\nif [[ ! -x dist/ddc-cell-js ]]; then\n  echo '❌ MISSING: ddc-cell-js'\n  missing=1\nelse\n  echo '✓ ddc-cell-js'\nfi\n\nif [[ ! -x dist/ddc-cell-jxl ]]; then\n  echo '❌ MISSING: ddc-cell-jxl'\n  missing=1\nelse\n  echo '✓ ddc-cell-jxl'\nfi\n\nif [[ ! -x dist/ddc-cell-linkcheck ]]; then\n  echo '❌ MISSING: ddc-cell-linkcheck'\n  missing=1\nelse\n  echo '✓ ddc-cell-linkcheck'\nfi\n\nif [[ ! -x dist/ddc-cell-markdown ]]; then\n  echo '❌ MISSING: ddc-cell-markdown'\n  missing=1\nelse\n  echo '✓ ddc-cell-markdown'\nfi\n\nif [[ ! -x dist/ddc-cell-minify ]]; then\n  echo '❌ MISSING: ddc-cell-minify'\n  missing=1\nelse\n  echo '✓ ddc-cell-minify'\nfi\n\nif [[ ! -x dist/ddc-cell-pagefind ]]; then\n  echo '❌ MISSING: ddc-cell-pagefind'\n  missing=1\nelse\n  echo '✓ ddc-cell-pagefind'\nfi\n\nif [[ ! -x dist/ddc-cell-sass ]]; then\n  echo '❌ MISSING: ddc-cell-sass'\n  missing=1\nelse\n  echo '✓ ddc-cell-sass'\nfi\n\nif [[ ! -x dist/ddc-cell-svgo ]]; then\n  echo '❌ MISSING: ddc-cell-svgo'\n  missing=1\nelse\n  echo '✓ ddc-cell-svgo'\nfi\n\nif [[ ! -x dist/ddc-cell-tui ]]; then\n  echo '❌ MISSING: ddc-cell-tui'\n  missing=1\nelse\n  echo '✓ ddc-cell-tui'\nfi\n\nif [[ ! -x dist/ddc-cell-webp ]]; then\n  echo '❌ MISSING: ddc-cell-webp'\n  missing=1\nelse\n  echo '✓ ddc-cell-webp'\nfi\n\nif [[ $missing -eq 1 ]]; then\n  echo ''\n  echo 'ERROR: Some required binaries are missing!'\n  echo 'This usually means a cell build job failed or artifact upload was incomplete.'\n  exit 1\nfi\n\necho ''\necho 'All 19 binaries verified.'\n"
      - 
        name: Run integration tests
        run: cargo xtask integration --no-build
        env: 
          DODECA_BIN: ${{ github.workspace }}/dist/ddc
          DODECA_CELL_PATH: ${{ github.workspace }}/dist

      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/home/amos/.cache/dodeca-ci/integration-linux-x64\")\"\nrm -rf \"/home/amos/.cache/dodeca-ci/integration-linux-x64\" 2>/dev/null || true\nctree target \"/home/amos/.cache/dodeca-ci/integration-linux-x64\" && echo \"Cache saved via ctree to /home/amos/.cache/dodeca-ci/integration-linux-x64\" || echo \"ctree save failed (non-fatal)\""

  assemble-linux-x64: 
    name: Assemble (linux-x64)
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    needs: 
      - integration-linux-x64
      - build-wasm

    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Download ddc from S3
        run: "./scripts/cas-download.ts \"ci/${{ github.run_id }}/ddc-linux-x64\" target/release/ddc"
      - 
        name: Download cells from S3
        run: "./scripts/cas-download-batch.sh \"ci/${{ github.run_id }}/cells-linux-x64\" target/release/"
      - 
        name: Download WASM from S3
        run: "./scripts/cas-download.ts \"ci/${{ github.run_id }}/wasm.tar.gz\" /tmp/wasm.tar.gz\nmkdir -p crates/dodeca-devtools\ntar -xzf /tmp/wasm.tar.gz -C crates/dodeca-devtools"
      - 
        name: Install xz (macOS)
        run: if command -v brew >/dev/null 2>&1; then HOMEBREW_NO_AUTO_UPDATE=1 brew install xz; fi
      - 
        name: List binaries
        run: ls -la target/release/
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh x86_64-unknown-linux-gnu
      - 
        name: Upload archive to S3
        run: "./scripts/cas-upload.ts \"dodeca-x86_64-unknown-linux-gnu.tar.xz\" \"ci/${{ github.run_id }}/dodeca-x86_64-unknown-linux-gnu.tar.xz\""

  build-ddc-macos-arm64: 
    name: Build ddc (macos-arm64)
    runs-on: 
      - mac-arm64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/Users/amos/.cache/dodeca-ci/ddc-macos-arm64\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/Users/amos/.cache/dodeca-ci/ddc-macos-arm64\" target && echo \"Cache restored via ctree from /Users/amos/.cache/dodeca-ci/ddc-macos-arm64\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /Users/amos/.cache/dodeca-ci/ddc-macos-arm64\"\nfi"
      - 
        name: Build ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness build --release -p dodeca
      - 
        name: Test ddc
        run: cargo +nightly-2025-12-19 -Z checksum-freshness test --release -p dodeca --bins
      - 
        name: Upload ddc to S3
        run: "./scripts/cas-upload.ts target/release/ddc \"ci/${{ github.run_id }}/ddc-macos-arm64\""
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/Users/amos/.cache/dodeca-ci/ddc-macos-arm64\")\"\nrm -rf \"/Users/amos/.cache/dodeca-ci/ddc-macos-arm64\" 2>/dev/null || true\nctree target \"/Users/amos/.cache/dodeca-ci/ddc-macos-arm64\" && echo \"Cache saved via ctree to /Users/amos/.cache/dodeca-ci/ddc-macos-arm64\" || echo \"ctree save failed (non-fatal)\""

  build-cells-macos-arm64-1: 
    name: Build cells (macos-arm64) [cell-arborium, cell-code-execution, cell-css, cell-fonts, cell-html, cell-html-diff, cell-http, cell-image, cell-js]
    runs-on: 
      - mac-arm64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\" target && echo \"Cache restored via ctree from /Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\"\nfi"
      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness build --release -p cell-arborium --bin ddc-cell-arborium -p cell-code-execution --bin ddc-cell-code-execution -p cell-css --bin ddc-cell-css -p cell-fonts --bin ddc-cell-fonts -p cell-html --bin ddc-cell-html -p cell-html-diff --bin ddc-cell-html-diff -p cell-http --bin ddc-cell-http -p cell-image --bin ddc-cell-image -p cell-js --bin ddc-cell-js
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness test --release -p cell-arborium -p cell-code-execution -p cell-css -p cell-fonts -p cell-html -p cell-html-diff -p cell-http -p cell-image -p cell-js
      - 
        name: Upload cells to S3
        run: "./scripts/cas-upload-batch.sh \"ci/${{ github.run_id }}/cells-macos-arm64\" target/release/ddc-cell-arborium target/release/ddc-cell-code-execution target/release/ddc-cell-css target/release/ddc-cell-fonts target/release/ddc-cell-html target/release/ddc-cell-html-diff target/release/ddc-cell-http target/release/ddc-cell-image target/release/ddc-cell-js"
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\")\"\nrm -rf \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\" 2>/dev/null || true\nctree target \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\" && echo \"Cache saved via ctree to /Users/amos/.cache/dodeca-ci/cells-macos-arm64-1\" || echo \"ctree save failed (non-fatal)\""

  build-cells-macos-arm64-2: 
    name: Build cells (macos-arm64) [cell-jxl, cell-linkcheck, cell-markdown, cell-minify, cell-pagefind, cell-sass, cell-svgo, cell-tui, cell-webp]
    runs-on: 
      - mac-arm64-metal

    timeout-minutes: 30
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\" target && echo \"Cache restored via ctree from /Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\"\nfi"
      - 
        name: Build cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness build --release -p cell-jxl --bin ddc-cell-jxl -p cell-linkcheck --bin ddc-cell-linkcheck -p cell-markdown --bin ddc-cell-markdown -p cell-minify --bin ddc-cell-minify -p cell-pagefind --bin ddc-cell-pagefind -p cell-sass --bin ddc-cell-sass -p cell-svgo --bin ddc-cell-svgo -p cell-tui --bin ddc-cell-tui -p cell-webp --bin ddc-cell-webp
      - 
        name: Test cells
        run: cargo +nightly-2025-12-19 -Z checksum-freshness test --release -p cell-jxl -p cell-linkcheck -p cell-markdown -p cell-minify -p cell-pagefind -p cell-sass -p cell-svgo -p cell-tui -p cell-webp
      - 
        name: Upload cells to S3
        run: "./scripts/cas-upload-batch.sh \"ci/${{ github.run_id }}/cells-macos-arm64\" target/release/ddc-cell-jxl target/release/ddc-cell-linkcheck target/release/ddc-cell-markdown target/release/ddc-cell-minify target/release/ddc-cell-pagefind target/release/ddc-cell-sass target/release/ddc-cell-svgo target/release/ddc-cell-tui target/release/ddc-cell-webp"
      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\")\"\nrm -rf \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\" 2>/dev/null || true\nctree target \"/Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\" && echo \"Cache saved via ctree to /Users/amos/.cache/dodeca-ci/cells-macos-arm64-2\" || echo \"ctree save failed (non-fatal)\""

  integration-macos-arm64: 
    name: Integration (macos-arm64)
    runs-on: 
      - mac-arm64-metal

    timeout-minutes: 30
    needs: 
      - build-ddc-macos-arm64
      - build-cells-macos-arm64-1
      - build-cells-macos-arm64-2

    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Install Rust
        uses: "https://github.com/dtolnay/rust-toolchain@master"
        with: 
          toolchain: nightly-2025-12-19

      - 
        name: Restore cache (ctree)
        run: "if [ -d \"/Users/amos/.cache/dodeca-ci/integration-macos-arm64\" ]; then\n  rm -rf target 2>/dev/null || true\n  ctree \"/Users/amos/.cache/dodeca-ci/integration-macos-arm64\" target && echo \"Cache restored via ctree from /Users/amos/.cache/dodeca-ci/integration-macos-arm64\" || echo \"ctree failed, starting fresh\"\n  # CMake build directories are not relocatable - they contain absolute paths.\n  # Nuke them to force a fresh CMake configure on path changes.\n  find target -path '*/build/*/out/build/CMakeCache.txt' -delete 2>/dev/null || true\n  find target -path '*/build/*/out/build/CMakeFiles' -type d -exec rm -rf {} + 2>/dev/null || true\n  echo \"Cleaned CMake caches (non-relocatable)\"\nelse\n  echo \"No cache found at /Users/amos/.cache/dodeca-ci/integration-macos-arm64\"\nfi"
      - 
        name: Download ddc from S3
        run: "./scripts/cas-download.ts \"ci/${{ github.run_id }}/ddc-macos-arm64\" dist/ddc"
      - 
        name: Download cells from S3
        run: "./scripts/cas-download-batch.sh \"ci/${{ github.run_id }}/cells-macos-arm64\" dist/"
      - 
        name: List binaries
        run: ls -la dist/
      - 
        name: Verify artifacts
        run: "#!/bin/bash\nset -euo pipefail\n\necho 'Verifying all required binaries exist in dist/'\nmissing=0\n\nif [[ ! -x dist/ddc ]]; then\n  echo '❌ MISSING: ddc'\n  missing=1\nelse\n  echo '✓ ddc'\nfi\n\nif [[ ! -x dist/ddc-cell-arborium ]]; then\n  echo '❌ MISSING: ddc-cell-arborium'\n  missing=1\nelse\n  echo '✓ ddc-cell-arborium'\nfi\n\nif [[ ! -x dist/ddc-cell-code-execution ]]; then\n  echo '❌ MISSING: ddc-cell-code-execution'\n  missing=1\nelse\n  echo '✓ ddc-cell-code-execution'\nfi\n\nif [[ ! -x dist/ddc-cell-css ]]; then\n  echo '❌ MISSING: ddc-cell-css'\n  missing=1\nelse\n  echo '✓ ddc-cell-css'\nfi\n\nif [[ ! -x dist/ddc-cell-fonts ]]; then\n  echo '❌ MISSING: ddc-cell-fonts'\n  missing=1\nelse\n  echo '✓ ddc-cell-fonts'\nfi\n\nif [[ ! -x dist/ddc-cell-html ]]; then\n  echo '❌ MISSING: ddc-cell-html'\n  missing=1\nelse\n  echo '✓ ddc-cell-html'\nfi\n\nif [[ ! -x dist/ddc-cell-html-diff ]]; then\n  echo '❌ MISSING: ddc-cell-html-diff'\n  missing=1\nelse\n  echo '✓ ddc-cell-html-diff'\nfi\n\nif [[ ! -x dist/ddc-cell-http ]]; then\n  echo '❌ MISSING: ddc-cell-http'\n  missing=1\nelse\n  echo '✓ ddc-cell-http'\nfi\n\nif [[ ! -x dist/ddc-cell-image ]]; then\n  echo '❌ MISSING: ddc-cell-image'\n  missing=1\nelse\n  echo '✓ ddc-cell-image'\nfi\n\nif [[ ! -x dist/ddc-cell-js ]]; then\n  echo '❌ MISSING: ddc-cell-js'\n  missing=1\nelse\n  echo '✓ ddc-cell-js'\nfi\n\nif [[ ! -x dist/ddc-cell-jxl ]]; then\n  echo '❌ MISSING: ddc-cell-jxl'\n  missing=1\nelse\n  echo '✓ ddc-cell-jxl'\nfi\n\nif [[ ! -x dist/ddc-cell-linkcheck ]]; then\n  echo '❌ MISSING: ddc-cell-linkcheck'\n  missing=1\nelse\n  echo '✓ ddc-cell-linkcheck'\nfi\n\nif [[ ! -x dist/ddc-cell-markdown ]]; then\n  echo '❌ MISSING: ddc-cell-markdown'\n  missing=1\nelse\n  echo '✓ ddc-cell-markdown'\nfi\n\nif [[ ! -x dist/ddc-cell-minify ]]; then\n  echo '❌ MISSING: ddc-cell-minify'\n  missing=1\nelse\n  echo '✓ ddc-cell-minify'\nfi\n\nif [[ ! -x dist/ddc-cell-pagefind ]]; then\n  echo '❌ MISSING: ddc-cell-pagefind'\n  missing=1\nelse\n  echo '✓ ddc-cell-pagefind'\nfi\n\nif [[ ! -x dist/ddc-cell-sass ]]; then\n  echo '❌ MISSING: ddc-cell-sass'\n  missing=1\nelse\n  echo '✓ ddc-cell-sass'\nfi\n\nif [[ ! -x dist/ddc-cell-svgo ]]; then\n  echo '❌ MISSING: ddc-cell-svgo'\n  missing=1\nelse\n  echo '✓ ddc-cell-svgo'\nfi\n\nif [[ ! -x dist/ddc-cell-tui ]]; then\n  echo '❌ MISSING: ddc-cell-tui'\n  missing=1\nelse\n  echo '✓ ddc-cell-tui'\nfi\n\nif [[ ! -x dist/ddc-cell-webp ]]; then\n  echo '❌ MISSING: ddc-cell-webp'\n  missing=1\nelse\n  echo '✓ ddc-cell-webp'\nfi\n\nif [[ $missing -eq 1 ]]; then\n  echo ''\n  echo 'ERROR: Some required binaries are missing!'\n  echo 'This usually means a cell build job failed or artifact upload was incomplete.'\n  exit 1\nfi\n\necho ''\necho 'All 19 binaries verified.'\n"
      - 
        name: Run integration tests
        run: cargo xtask integration --no-build
        env: 
          DODECA_BIN: ${{ github.workspace }}/dist/ddc
          DODECA_CELL_PATH: ${{ github.workspace }}/dist

      - 
        name: Save cache (ctree)
        run: "mkdir -p \"$(dirname \"/Users/amos/.cache/dodeca-ci/integration-macos-arm64\")\"\nrm -rf \"/Users/amos/.cache/dodeca-ci/integration-macos-arm64\" 2>/dev/null || true\nctree target \"/Users/amos/.cache/dodeca-ci/integration-macos-arm64\" && echo \"Cache saved via ctree to /Users/amos/.cache/dodeca-ci/integration-macos-arm64\" || echo \"ctree save failed (non-fatal)\""

  assemble-macos-arm64: 
    name: Assemble (macos-arm64)
    runs-on: 
      - mac-arm64-metal

    timeout-minutes: 30
    needs: 
      - integration-macos-arm64
      - build-wasm

    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Download ddc from S3
        run: "./scripts/cas-download.ts \"ci/${{ github.run_id }}/ddc-macos-arm64\" target/release/ddc"
      - 
        name: Download cells from S3
        run: "./scripts/cas-download-batch.sh \"ci/${{ github.run_id }}/cells-macos-arm64\" target/release/"
      - 
        name: Download WASM from S3
        run: "./scripts/cas-download.ts \"ci/${{ github.run_id }}/wasm.tar.gz\" /tmp/wasm.tar.gz\nmkdir -p crates/dodeca-devtools\ntar -xzf /tmp/wasm.tar.gz -C crates/dodeca-devtools"
      - 
        name: Install xz (macOS)
        run: if command -v brew >/dev/null 2>&1; then HOMEBREW_NO_AUTO_UPDATE=1 brew install xz; fi
      - 
        name: List binaries
        run: ls -la target/release/
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh aarch64-apple-darwin
      - 
        name: Upload archive to S3
        run: "./scripts/cas-upload.ts \"dodeca-aarch64-apple-darwin.tar.xz\" \"ci/${{ github.run_id }}/dodeca-aarch64-apple-darwin.tar.xz\""

  release: 
    name: Release
    runs-on: 
      - linux-amd64-metal

    timeout-minutes: 30
    needs: 
      - assemble-linux-x64
      - assemble-macos-arm64

    if: "startsWith(github.ref, 'refs/tags/')"
    env: 
      AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

    steps: 
      - 
        name: Checkout
        uses: "https://github.com/actions/checkout@v4"
      - 
        name: Download archives from S3
        run: "mkdir -p dist\n./scripts/cas-download.ts \"ci/${{ github.run_id }}/dodeca-x86_64-unknown-linux-gnu.tar.xz\" dist/dodeca-x86_64-unknown-linux-gnu.tar.xz\n./scripts/cas-download.ts \"ci/${{ github.run_id }}/dodeca-aarch64-apple-darwin.tar.xz\" dist/dodeca-aarch64-apple-darwin.tar.xz\nls -la dist/"
      - 
        name: Show release info
        run: "echo \"Release: ${{ github.ref_name }}\"; ls -la dist/"

