# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: CI
"on": 
  push: 
    branches: 
      - main

  pull_request: 
    branches: 
      - main

jobs: 
  check-windows: 
    name: Check (Windows)
    runs-on: depot-windows-2022-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: wasm32-unknown-unknown

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: cargo install wasm-pack
        shell: bash
      - 
        name: Build
        run: cargo xtask build
        shell: bash
      - 
        name: Check
        run: cargo check --all-features
        shell: bash

  build-linux: 
    name: Build (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: "curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh"
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
      - 
        name: Build plugins
        run: cargo build --release -p mod-webp --bin dodeca-mod-webp -p mod-jxl --bin dodeca-mod-jxl -p mod-image --bin dodeca-mod-image -p mod-minify --bin dodeca-mod-minify -p mod-css --bin dodeca-mod-css -p mod-sass --bin dodeca-mod-sass -p mod-html-diff --bin dodeca-mod-html-diff -p mod-fonts --bin dodeca-mod-fonts -p mod-pagefind --bin dodeca-mod-pagefind -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-svgo --bin dodeca-mod-svgo -p mod-arborium --bin dodeca-mod-arborium -p mod-js --bin dodeca-mod-js -p mod-code-execution --bin dodeca-mod-code-execution -p mod-http --bin dodeca-mod-http
      - 
        name: Test ddc
        run: cargo test --release -p dodeca --lib
      - 
        name: Test plugins
        run: cargo test --release -p mod-webp -p mod-jxl -p mod-image -p mod-minify -p mod-css -p mod-sass -p mod-html-diff -p mod-fonts -p mod-pagefind -p mod-linkcheck -p mod-svgo -p mod-arborium -p mod-js -p mod-code-execution -p mod-http
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/target/release/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/target/release


  build-macos: 
    name: Build (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: brew install wasm-pack
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
      - 
        name: Build plugins
        run: cargo build --release -p mod-webp --bin dodeca-mod-webp -p mod-jxl --bin dodeca-mod-jxl -p mod-image --bin dodeca-mod-image -p mod-minify --bin dodeca-mod-minify -p mod-css --bin dodeca-mod-css -p mod-sass --bin dodeca-mod-sass -p mod-html-diff --bin dodeca-mod-html-diff -p mod-fonts --bin dodeca-mod-fonts -p mod-pagefind --bin dodeca-mod-pagefind -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-svgo --bin dodeca-mod-svgo -p mod-arborium --bin dodeca-mod-arborium -p mod-js --bin dodeca-mod-js -p mod-code-execution --bin dodeca-mod-code-execution -p mod-http --bin dodeca-mod-http
      - 
        name: Test ddc
        run: cargo test --release -p dodeca --lib
      - 
        name: Test plugins
        run: cargo test --release -p mod-webp -p mod-jxl -p mod-image -p mod-minify -p mod-css -p mod-sass -p mod-html-diff -p mod-fonts -p mod-pagefind -p mod-linkcheck -p mod-svgo -p mod-arborium -p mod-js -p mod-code-execution -p mod-http
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/target/release/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/target/release


