# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: CI
"on": 
  push: 
    branches: 
      - main

  pull_request: 
    branches: 
      - main

jobs: 
  check-windows: 
    name: Check (Windows)
    runs-on: depot-windows-2022-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: wasm32-unknown-unknown

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: cargo install wasm-pack
        shell: bash
      - 
        name: Build
        run: cargo xtask build
        shell: bash
      - 
        name: Check
        run: cargo check --all-features
        shell: bash

  build-ddc-linux: 
    name: Build ddc (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: "curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh"
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
      - 
        name: Verify ddc binary exists
        run: ls -la target/release/ddc
      - 
        name: Run ddc unit tests
        run: cargo test --release -p dodeca --lib
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: ddc-linux
          path: target/release/ddc


  build-plugins-image-linux: 
    name: Build plugins/image (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build image plugins
        run: cargo build --release -p mod-webp --bin dodeca-mod-webp -p mod-jxl --bin dodeca-mod-jxl -p mod-image --bin dodeca-mod-image
      - 
        name: Test image plugins
        run: cargo test --release -p mod-webp -p mod-jxl -p mod-image
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-image-linux
          path: "target/release/dodeca-mod-webp\ntarget/release/dodeca-mod-jxl\ntarget/release/dodeca-mod-image"
          retention-days: "1"


  build-plugins-web-linux: 
    name: Build plugins/web (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build web plugins
        run: cargo build --release -p mod-minify --bin dodeca-mod-minify -p mod-css --bin dodeca-mod-css -p mod-sass --bin dodeca-mod-sass -p mod-html-diff --bin dodeca-mod-html-diff
      - 
        name: Test web plugins
        run: cargo test --release -p mod-minify -p mod-css -p mod-sass -p mod-html-diff
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-web-linux
          path: "target/release/dodeca-mod-minify\ntarget/release/dodeca-mod-css\ntarget/release/dodeca-mod-sass\ntarget/release/dodeca-mod-html-diff"
          retention-days: "1"


  build-plugins-misc-linux: 
    name: Build plugins/misc (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build misc plugins
        run: cargo build --release -p mod-fonts --bin dodeca-mod-fonts -p mod-pagefind --bin dodeca-mod-pagefind -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-svgo --bin dodeca-mod-svgo -p mod-arborium --bin dodeca-mod-arborium
      - 
        name: Test misc plugins
        run: cargo test --release -p mod-fonts -p mod-pagefind -p mod-linkcheck -p mod-svgo -p mod-arborium
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-misc-linux
          path: "target/release/dodeca-mod-fonts\ntarget/release/dodeca-mod-pagefind\ntarget/release/dodeca-mod-linkcheck\ntarget/release/dodeca-mod-svgo\ntarget/release/dodeca-mod-arborium"
          retention-days: "1"


  build-plugins-js-linux: 
    name: Build plugins/js (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build js plugins
        run: cargo build --release -p mod-js --bin dodeca-mod-js
      - 
        name: Test js plugins
        run: cargo test --release -p mod-js
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-js-linux
          path: target/release/dodeca-mod-js
          retention-days: "1"


  build-plugins-code-linux: 
    name: Build plugins/code (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build code plugins
        run: cargo build --release -p mod-code-execution --bin dodeca-mod-code-execution
      - 
        name: Test code plugins
        run: cargo test --release -p mod-code-execution
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-code-linux
          path: target/release/dodeca-mod-code-execution
          retention-days: "1"


  build-plugins-http-linux: 
    name: Build plugins/http (linux)
    runs-on: depot-ubuntu-24.04-16
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build http plugins
        run: cargo build --release -p mod-http --bin dodeca-mod-http
      - 
        name: Test http plugins
        run: cargo test --release -p mod-http
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-http-linux
          path: target/release/dodeca-mod-http
          retention-days: "1"


  integration-linux: 
    name: Integration (linux)
    runs-on: depot-ubuntu-24.04-16
    needs: 
      - build-ddc-linux
      - build-plugins-image-linux
      - build-plugins-web-linux
      - build-plugins-misc-linux
      - build-plugins-js-linux
      - build-plugins-code-linux
      - build-plugins-http-linux

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-linux
          path: artifacts/bin

      - 
        name: Download plugins
        uses: actions/download-artifact@v4
        with: 
          pattern: plugins-*-linux
          path: artifacts/plugins
          merge-multiple: "true"

      - 
        name: List artifacts
        run: ls -laR artifacts/
      - 
        name: Make ddc executable
        run: chmod +x artifacts/bin/ddc
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/artifacts/bin/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/artifacts/plugins


  build-ddc-macos: 
    name: Build ddc (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install wasm-pack
        run: brew install wasm-pack
      - 
        name: Build WASM
        run: cargo xtask wasm
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
      - 
        name: Verify ddc binary exists
        run: ls -la target/release/ddc
      - 
        name: Run ddc unit tests
        run: cargo test --release -p dodeca --lib
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: ddc-macos
          path: target/release/ddc


  build-plugins-image-macos: 
    name: Build plugins/image (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build image plugins
        run: cargo build --release -p mod-webp --bin dodeca-mod-webp -p mod-jxl --bin dodeca-mod-jxl -p mod-image --bin dodeca-mod-image
      - 
        name: Test image plugins
        run: cargo test --release -p mod-webp -p mod-jxl -p mod-image
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-image-macos
          path: "target/release/dodeca-mod-webp\ntarget/release/dodeca-mod-jxl\ntarget/release/dodeca-mod-image"
          retention-days: "1"


  build-plugins-web-macos: 
    name: Build plugins/web (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build web plugins
        run: cargo build --release -p mod-minify --bin dodeca-mod-minify -p mod-css --bin dodeca-mod-css -p mod-sass --bin dodeca-mod-sass -p mod-html-diff --bin dodeca-mod-html-diff
      - 
        name: Test web plugins
        run: cargo test --release -p mod-minify -p mod-css -p mod-sass -p mod-html-diff
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-web-macos
          path: "target/release/dodeca-mod-minify\ntarget/release/dodeca-mod-css\ntarget/release/dodeca-mod-sass\ntarget/release/dodeca-mod-html-diff"
          retention-days: "1"


  build-plugins-misc-macos: 
    name: Build plugins/misc (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build misc plugins
        run: cargo build --release -p mod-fonts --bin dodeca-mod-fonts -p mod-pagefind --bin dodeca-mod-pagefind -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-svgo --bin dodeca-mod-svgo -p mod-arborium --bin dodeca-mod-arborium
      - 
        name: Test misc plugins
        run: cargo test --release -p mod-fonts -p mod-pagefind -p mod-linkcheck -p mod-svgo -p mod-arborium
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-misc-macos
          path: "target/release/dodeca-mod-fonts\ntarget/release/dodeca-mod-pagefind\ntarget/release/dodeca-mod-linkcheck\ntarget/release/dodeca-mod-svgo\ntarget/release/dodeca-mod-arborium"
          retention-days: "1"


  build-plugins-js-macos: 
    name: Build plugins/js (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build js plugins
        run: cargo build --release -p mod-js --bin dodeca-mod-js
      - 
        name: Test js plugins
        run: cargo test --release -p mod-js
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-js-macos
          path: target/release/dodeca-mod-js
          retention-days: "1"


  build-plugins-code-macos: 
    name: Build plugins/code (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build code plugins
        run: cargo build --release -p mod-code-execution --bin dodeca-mod-code-execution
      - 
        name: Test code plugins
        run: cargo test --release -p mod-code-execution
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-code-macos
          path: target/release/dodeca-mod-code-execution
          retention-days: "1"


  build-plugins-http-macos: 
    name: Build plugins/http (macos)
    runs-on: depot-macos-15
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build http plugins
        run: cargo build --release -p mod-http --bin dodeca-mod-http
      - 
        name: Test http plugins
        run: cargo test --release -p mod-http
      - 
        name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-http-macos
          path: target/release/dodeca-mod-http
          retention-days: "1"


  integration-macos: 
    name: Integration (macos)
    runs-on: depot-macos-15
    needs: 
      - build-ddc-macos
      - build-plugins-image-macos
      - build-plugins-web-macos
      - build-plugins-misc-macos
      - build-plugins-js-macos
      - build-plugins-code-macos
      - build-plugins-http-macos

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Download ddc
        uses: actions/download-artifact@v4
        with: 
          name: ddc-macos
          path: artifacts/bin

      - 
        name: Download plugins
        uses: actions/download-artifact@v4
        with: 
          pattern: plugins-*-macos
          path: artifacts/plugins
          merge-multiple: "true"

      - 
        name: List artifacts
        run: ls -laR artifacts/
      - 
        name: Make ddc executable
        run: chmod +x artifacts/bin/ddc
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/artifacts/bin/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/artifacts/plugins


