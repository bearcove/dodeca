# GENERATED BY: cargo xtask ci
# DO NOT EDIT - edit xtask/src/ci.rs instead

---
name: CI
"on": 
  push: 
    tags: 
      - v*

    branches: 
      - main

  pull_request: 
    branches: 
      - main

  workflow_dispatch: 
permissions: 
  contents: write

env: 
  CARGO_TERM_COLOR: always

jobs: 
  build-linux-x64: 
    name: Build (linux-x64)
    runs-on: depot-ubuntu-24.04-32
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"

      - 
        name: Install wasm-pack
        run: "curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh"
        shell: bash
      - 
        name: Build WASM
        run: cargo xtask wasm
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
        shell: bash
      - 
        name: Build plugins
        run: cargo build --release -p mod-arborium --bin dodeca-mod-arborium -p mod-code-execution --bin dodeca-mod-code-execution -p mod-css --bin dodeca-mod-css -p mod-fonts --bin dodeca-mod-fonts -p mod-html-diff --bin dodeca-mod-html-diff -p mod-http --bin dodeca-mod-http -p mod-image --bin dodeca-mod-image -p mod-js --bin dodeca-mod-js -p mod-jxl --bin dodeca-mod-jxl -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-minify --bin dodeca-mod-minify -p mod-pagefind --bin dodeca-mod-pagefind -p mod-sass --bin dodeca-mod-sass -p mod-svgo --bin dodeca-mod-svgo -p mod-webp --bin dodeca-mod-webp
        shell: bash
      - 
        name: Test ddc
        run: cargo test --release -p dodeca
        shell: bash
      - 
        name: Test plugins
        run: cargo test --release -p mod-arborium -p mod-code-execution -p mod-css -p mod-fonts -p mod-html-diff -p mod-http -p mod-image -p mod-js -p mod-jxl -p mod-linkcheck -p mod-minify -p mod-pagefind -p mod-sass -p mod-svgo -p mod-webp
        shell: bash
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
        shell: bash
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh x86_64-unknown-linux-gnu
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-linux-x64
          path: dodeca-x86_64-unknown-linux-gnu.tar.xz


  build-linux-arm64: 
    name: Build (linux-arm64)
    runs-on: depot-ubuntu-24.04-arm-32
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: aarch64-unknown-linux-gnu

      - 
        name: Install cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"

      - 
        name: Build ddc
        run: cargo build --release -p dodeca --target aarch64-unknown-linux-gnu
        shell: bash
      - 
        name: Build plugins
        run: cargo build --release --target aarch64-unknown-linux-gnu -p mod-arborium --bin dodeca-mod-arborium -p mod-code-execution --bin dodeca-mod-code-execution -p mod-css --bin dodeca-mod-css -p mod-fonts --bin dodeca-mod-fonts -p mod-html-diff --bin dodeca-mod-html-diff -p mod-http --bin dodeca-mod-http -p mod-image --bin dodeca-mod-image -p mod-js --bin dodeca-mod-js -p mod-jxl --bin dodeca-mod-jxl -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-minify --bin dodeca-mod-minify -p mod-pagefind --bin dodeca-mod-pagefind -p mod-sass --bin dodeca-mod-sass -p mod-svgo --bin dodeca-mod-svgo -p mod-webp --bin dodeca-mod-webp
        shell: bash
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh aarch64-unknown-linux-gnu
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-linux-arm64
          path: dodeca-aarch64-unknown-linux-gnu.tar.xz


  build-macos-arm64: 
    name: Build (macos-arm64)
    runs-on: depot-macos-latest
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          components: clippy
          targets: wasm32-unknown-unknown

      - 
        name: Install Rust (nightly)
        uses: dtolnay/rust-toolchain@nightly
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"

      - 
        name: Install wasm-pack
        run: brew install wasm-pack
        shell: bash
      - 
        name: Build WASM
        run: cargo xtask wasm
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
        shell: bash
      - 
        name: Build plugins
        run: cargo build --release -p mod-arborium --bin dodeca-mod-arborium -p mod-code-execution --bin dodeca-mod-code-execution -p mod-css --bin dodeca-mod-css -p mod-fonts --bin dodeca-mod-fonts -p mod-html-diff --bin dodeca-mod-html-diff -p mod-http --bin dodeca-mod-http -p mod-image --bin dodeca-mod-image -p mod-js --bin dodeca-mod-js -p mod-jxl --bin dodeca-mod-jxl -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-minify --bin dodeca-mod-minify -p mod-pagefind --bin dodeca-mod-pagefind -p mod-sass --bin dodeca-mod-sass -p mod-svgo --bin dodeca-mod-svgo -p mod-webp --bin dodeca-mod-webp
        shell: bash
      - 
        name: Test ddc
        run: cargo test --release -p dodeca
        shell: bash
      - 
        name: Test plugins
        run: cargo test --release -p mod-arborium -p mod-code-execution -p mod-css -p mod-fonts -p mod-html-diff -p mod-http -p mod-image -p mod-js -p mod-jxl -p mod-linkcheck -p mod-minify -p mod-pagefind -p mod-sass -p mod-svgo -p mod-webp
        shell: bash
      - 
        name: Clippy
        run: cargo clippy --all-features --all-targets -- -D warnings
        shell: bash
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh aarch64-apple-darwin
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-macos-arm64
          path: dodeca-aarch64-apple-darwin.tar.xz


  build-windows-x64: 
    name: Build (windows-x64)
    runs-on: depot-windows-2022-16
    env: 
      RUSTFLAGS: "-Ctarget-feature=+crt-static"

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with: 
          targets: wasm32-unknown-unknown

      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"

      - 
        name: Install wasm-pack
        run: cargo install wasm-pack
        shell: bash
      - 
        name: Build WASM
        run: cargo xtask wasm
        shell: bash
      - 
        name: Build ddc
        run: cargo build --release -p dodeca
        shell: bash
      - 
        name: Build plugins
        run: cargo build --release -p mod-arborium --bin dodeca-mod-arborium -p mod-code-execution --bin dodeca-mod-code-execution -p mod-css --bin dodeca-mod-css -p mod-fonts --bin dodeca-mod-fonts -p mod-html-diff --bin dodeca-mod-html-diff -p mod-http --bin dodeca-mod-http -p mod-image --bin dodeca-mod-image -p mod-js --bin dodeca-mod-js -p mod-jxl --bin dodeca-mod-jxl -p mod-linkcheck --bin dodeca-mod-linkcheck -p mod-minify --bin dodeca-mod-minify -p mod-pagefind --bin dodeca-mod-pagefind -p mod-sass --bin dodeca-mod-sass -p mod-svgo --bin dodeca-mod-svgo -p mod-webp --bin dodeca-mod-webp
        shell: bash
      - 
        name: Test ddc
        run: cargo test --release -p dodeca
        shell: bash
      - 
        name: Test plugins
        run: cargo test --release -p mod-arborium -p mod-code-execution -p mod-css -p mod-fonts -p mod-html-diff -p mod-http -p mod-image -p mod-js -p mod-jxl -p mod-linkcheck -p mod-minify -p mod-pagefind -p mod-sass -p mod-svgo -p mod-webp
        shell: bash
      - 
        name: Assemble archive
        run: bash scripts/assemble-archive.sh x86_64-pc-windows-msvc
        shell: bash
      - 
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: build-windows-x64
          path: dodeca-x86_64-pc-windows-msvc.zip


  integration-linux-x64: 
    name: Integration (linux-x64)
    runs-on: depot-ubuntu-24.04-32
    needs: 
      - build-linux-x64

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"

      - 
        name: Download build
        uses: actions/download-artifact@v4
        with: 
          name: build-linux-x64
          path: dist

      - 
        name: Extract archive
        run: tar -xf dist/dodeca-x86_64-unknown-linux-gnu.tar.xz -C dist && ls -la dist/
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/dist/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/dist


  integration-macos-arm64: 
    name: Integration (macos-arm64)
    runs-on: depot-macos-latest
    needs: 
      - build-macos-arm64

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-on-failure: "true"

      - 
        name: Download build
        uses: actions/download-artifact@v4
        with: 
          name: build-macos-arm64
          path: dist

      - 
        name: Extract archive
        run: tar -xf dist/dodeca-aarch64-apple-darwin.tar.xz -C dist && ls -la dist/
      - 
        name: Run integration tests
        run: "cargo test --release -p dodeca-integration --test '*'"
        env: 
          DODECA_BIN: ${{ github.workspace }}/dist/ddc
          DODECA_PLUGINS: ${{ github.workspace }}/dist


  release: 
    name: Release
    runs-on: ubuntu-latest
    needs: 
      - build-linux-x64
      - build-linux-arm64
      - build-macos-arm64
      - build-windows-x64

    if: "startsWith(github.ref, 'refs/tags/')"
    env: 
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download all artifacts
        uses: actions/download-artifact@v4
        with: 
          path: dist
          pattern: build-*
          merge-multiple: "true"

      - 
        name: List artifacts
        run: ls -laR dist/
      - 
        name: Create GitHub Release
        run: "gh release create \"${{ github.ref_name }}\" \\\n  --title \"dodeca ${{ github.ref_name }}\" \\\n  --generate-notes \\\n  dist/**/*.tar.xz dist/**/*.zip"
        shell: bash
      - 
        name: Update Homebrew tap
        run: "bash scripts/update-homebrew.sh \"${{ github.ref_name }}\""
        shell: bash

